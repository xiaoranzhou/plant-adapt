<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Adaptation Hub</title>
    
    <!-- Bootstrap CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="assets/css/main.css" rel="stylesheet">
    <link href="assets/css/gwas.css" rel="stylesheet">
        <script
      src="https://unpkg.com/@jbrowse/react-app2/dist/react-app.umd.production.min.js"
      crossorigin
    ></script>
</head>
<body>
    <!-- Header -->
    <header class="navbar navbar-dark sticky-top bg-success flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3 fs-6" href="https://dataplan.top">Plant Adaptation Hub</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <input class="form-control form-control-dark w-100 rounded-0 border-0" type="text" placeholder="Search" aria-label="Search">
        <div class="navbar-nav">
            <div class="nav-item text-nowrap">
                <a class="nav-link px-3" href="https://dataplan.top">Sign out</a>
            </div>
        </div>
    </header>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3 sidebar-sticky">
                    <ul class="nav flex-column nav-pills" id="sidebar-nav" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="home-tab" data-bs-toggle="pill" href="#home" role="tab" aria-controls="home" aria-selected="true">
                                Home
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="dashboard-tab" data-bs-toggle="pill" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false">
                                Data Dashboard
                            </a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="genomic-analysis-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Genomic Analysis
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="genomic-analysis-dropdown">
                                <li><a class="dropdown-item" id="gwas-tab" href="#gwas" role="tab" aria-controls="gwas" aria-selected="false">GWAS</a></li>
                                <li><a class="dropdown-item" id="analysis-general-tab" href="#analysis-general" role="tab" aria-controls="analysis-general" aria-selected="false">General Analysis</a></li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="observation-tab" data-bs-toggle="pill" href="#observation" role="tab" aria-controls="observation" aria-selected="false">
                                Genome Observation
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="browse-tab" data-bs-toggle="pill" href="#browse" role="tab" aria-controls="browse" aria-selected="false">
                                Genome Browse
                            </a>
                        </li>
                    </ul>

                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>Tools</span>
                        <a class="link-secondary" href="https://dataplan.top" aria-label="Add a new report"></a>
                    </h6>
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a class="nav-link" id="plink2-tab" data-bs-toggle="pill" href="#plink2pane" role="tab" aria-controls="plink2pane" aria-selected="false">Plink 2.0</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="plotly-tab" data-bs-toggle="pill" href="#plotly" role="tab" aria-controls="plotly" aria-selected="false">Manhattan Plotly</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="jb365-tab" data-bs-toggle="pill" href="#jb365" role="tab" aria-controls="jb365" aria-selected="false">JBrowse 3.6.5</a>
                        </li>

                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="tab-content" id="main-tab-content">
                    <!-- Home Tab -->
                    <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Plant Adaptation Hub - Home</h1>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Welcome to Plant Adaptation Hub</h5>
                                        <p class="card-text">Your comprehensive platform for plant genomic analysis and adaptation studies.</p>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="card mb-3">
                                                    <div class="card-body">
                                                        <h6 class="card-title">Data Dashboard</h6>
                                                        <p class="card-text">View and manage your genomic datasets.</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card mb-3">
                                                    <div class="card-body">
                                                        <h6 class="card-title">Genomic Analysis</h6>
                                                        <p class="card-text">Perform GWAS and other genomic analyses.</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card mb-3">
                                                    <div class="card-body">
                                                        <h6 class="card-title">Genome Browse</h6>
                                                        <p class="card-text">Browse and visualize genomic data.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Dashboard Tab -->
                    <div class="tab-pane fade" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Data Dashboard</h1>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Dataset Overview</h5>
                                        <p class="card-text">Manage and visualize your genomic datasets here.</p>
                                        <div class="alert alert-info">
                                            <strong>Info:</strong> Data dashboard features will be implemented here.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- GWAS Tab -->
                    <div class="tab-pane fade" id="gwas" role="tabpanel" aria-labelledby="gwas-tab">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">GWAS Analysis</h1>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Genome-Wide Association Studies</h5>
                                        <p class="card-text">Perform comprehensive GWAS analysis using PLINK2 and create interactive visualizations.</p>

                                        <div class="alert alert-info">
                                            <strong>Getting Started:</strong> Use the dedicated tools below for your GWAS workflow.
                                        </div>

                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="card mb-3">
                                                    <div class="card-body text-center">
                                                        <h6 class="card-title">1. Data Processing</h6>
                                                        <p class="card-text">Upload and process genomic data with PLINK2</p>
                                                        <button class="btn btn-primary" onclick="window.location.hash='#plink2pane'">
                                                            üß¨ Use PLINK2 Tool
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card mb-3">
                                                    <div class="card-body text-center">
                                                        <h6 class="card-title">2. Visualization</h6>
                                                        <p class="card-text">Create interactive Manhattan plots</p>
                                                        <button class="btn btn-success" onclick="window.location.hash='#plotly'">
                                                            üìä Manhattan Plot
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card mb-3">
                                                    <div class="card-body text-center">
                                                        <h6 class="card-title">3. Genome Browser</h6>
                                                        <p class="card-text">Explore genomic regions in detail</p>
                                                        <button class="btn btn-info" onclick="window.location.hash='#jb365'">
                                                            üß≠ JBrowse
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mt-4">
                                            <h6>GWAS Workflow:</h6>
                                            <ol>
                                                <li><strong>Data Upload:</strong> Upload your genomic files (.bed, .bim, .fam) using the PLINK2 tool</li>
                                                <li><strong>Quality Control:</strong> Run PLINK2 commands for data cleaning and QC</li>
                                                <li><strong>Association Analysis:</strong> Perform GWAS using the GLM method</li>
                                                <li><strong>Visualization:</strong> Create Manhattan plots to identify significant SNPs</li>
                                                <li><strong>Exploration:</strong> Navigate to significant regions using the genome browser</li>
                                            </ol>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- General Analysis Tab -->
                    <div class="tab-pane fade" id="analysis-general" role="tabpanel" aria-labelledby="analysis-general-tab">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">General Genomic Analysis</h1>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Analysis Tools</h5>
                                        <p class="card-text">General genomic analysis tools and workflows.</p>
                                        <div class="alert alert-info">
                                            <strong>Info:</strong> General analysis features will be implemented here.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Genome Observation Tab -->
                    <div class="tab-pane fade" id="observation" role="tabpanel" aria-labelledby="observation-tab">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Genome Observation</h1>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Genome Browse</h5>
                                        <p class="card-text">Observe and visualize genomic structures and variations.</p>
                                        

   
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Genome Browse Tab -->
                    <div class="tab-pane fade" id="browse" role="tabpanel" aria-labelledby="browse-tab">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div id="jbrowse_app"></div>
                            </div>
                        </div>
                    </div>
                    <!-- PLink 2.0 Tab -->
                    <div class="tab-pane fade" id="plink2pane" role="tabpanel" aria-labelledby="plink2-tab">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div id="plink2"></div>
                                 <div class="container-fluid">
                            <div class="file-upload-section">
                                <h3>Upload Files</h3>
                                <div class="file-group">
                                    <label for="fileInput">Select Files:</label>
                                    <input type="file" id="fileInput" multiple>
                                    <div id="fileStatus" class="file-status"></div>
                                </div>
                            </div>

                            <div class="controls">
                                <input type="text" class="command-input" id="commandInput"
                                       placeholder="Enter PLINK2 command (e.g.,--bfile plink --glm allow-no-covars)"
                                       value="--bfile plink --glm allow-no-covars">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="renameFamCheckbox" checked>
                                    Rename .fam
                                </label>
                                <button class="btn btn-primary" id="runButton" onclick="runPlink()">Run PLINK2</button>
                                <button class="btn btn-primary" id="clearButton" onclick="clearOutput()">Clear Output</button>
                            </div>

                            <div class="loading" id="loading">
                                <div class="spinner"></div>
                                <p>Processing with PLINK2...</p>
                            </div>

                            <div class="output-section">
                                <div class="output-tabs">
                                    <div class="tab active" onclick="switchTab('console')">Console Output</div>
                                    <div class="tab" onclick="switchTab('files')">Output Files</div>
                                    <div class="tab" onclick="switchTab('gwas')">GWAS Data Clean</div>
                                    <div class="tab" onclick="switchTab('manhattan')">Manhattan Plot</div>
                                    <div class="tab" onclick="switchTab('log')">Log</div>
                                </div>
                                
                                <div class="output-content" id="outputContent">
                                    <div id="consoleOutput">Ready to process PLINK2 files...</div>
                                    <div id="filesOutput" style="display: none;"></div>
                                    <div id="gwasOutput" style="display: none;">
                                        <div style="margin-bottom: 15px;">
                                            <button class="btn btn-primary" id="runGwasButton" onclick="runGwasAnalysis()" style="margin-right: 10px;">Run GWAS Data Clean</button>
                                            <span id="gwasStatus"></span>
                                        </div>
                                        <div id="gwasResults"></div>
                                    </div>
                                    <div id="manhattanOutput" style="display: none;">
                                        <div class="manhattan-controls" style="margin-bottom: 15px; text-align: center;">
                                            <button class="btn btn-primary" id="plotFromCleanedButton" onclick="plotFromCleanedData()" style="margin-right: 10px; background-color: #4CAF50;">Plot from Cleaned Data</button>
                                            <button class="btn btn-primary" onclick="toggleSignificanceLinePlot()" style="margin-right: 10px;">Toggle Significance Line</button>
                                            <button class="btn btn-primary" onclick="exportPlotImage()" style="margin-right: 10px; background-color: #2196F3;">Export PNG</button>
                                            <button class="btn btn-primary" onclick="exportPlotSVG()" style="margin-right: 10px; background-color: #FF9800;">Export SVG</button>
                                            <button class="btn btn-primary" onclick="clearManhattanPlot()">Clear</button>
                                        </div>
                                        <div class="progress" id="manhattanProgressSection" style="display: none; text-align: center; margin-bottom: 15px;">
                                            <div id="manhattanProgressMessage">Processing data...</div>
                                            <div style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0; position: relative;">
                                                <div id="manhattanProgressFill" style="height: 100%; background: linear-gradient(90deg, #4CAF50, #45a049); transition: width 0.3s ease; width: 0%;"></div>
                                                <div id="manhattanProgressText" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; color: #333; font-size: 12px;">0%</div>
                                            </div>
                                        </div>
                                        <div id="manhattanStats" style="text-align: center; margin: 10px 0; color: #666;">
                                            Ready to plot Manhattan plot from cleaned GWAS data
                                        </div>
                                        <div id="manhattanPlotDiv" style="width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa; color: #666;"></div>
                                    </div>
                                    <div id="logOutput" style="display: none;"></div>
                                </div>
                            </div>

                            <div class="file-info">
                               
                            </div>
                        </div>


                            </div>
                        </div>
                    </div>









                    <!-- Manhattan Plotly Tab -->
                    <div class="tab-pane fade" id="plotly" role="tabpanel" aria-labelledby="plotly-tab">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Manhattan Plot Visualization</h1>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Interactive Manhattan Plot</h5>
                                        <p class="card-text">Create interactive Manhattan plots from GWAS data with click-to-navigate functionality to the genome browser.</p>

                                        <div class="alert alert-info">
                                            <strong>Info:</strong> To create Manhattan plots, first run GWAS analysis in the PLINK2 tool, then use the cleaned data for visualization.
                                        </div>

                                        <div class="manhattan-controls" style="margin-bottom: 20px; text-align: center;">
                                            <button class="btn btn-success" id="plotFromCleanedButtonStandalone" onclick="plotFromCleanedDataStandalone()" style="margin-right: 10px;">
                                                üìä Plot from Cleaned Data
                                            </button>
                                            <button class="btn btn-secondary" onclick="toggleSignificanceLineStandalone()" style="margin-right: 10px;">
                                                üìà Toggle Significance Line
                                            </button>
                                            <button class="btn btn-primary" onclick="exportPlotImageStandalone()" style="margin-right: 10px;">
                                                üì• Export PNG
                                            </button>
                                            <button class="btn btn-warning" onclick="exportPlotSVGStandalone()" style="margin-right: 10px;">
                                                üì• Export SVG
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="clearManhattanPlotStandalone()">
                                                üóëÔ∏è Clear Plot
                                            </button>
                                        </div>

                                        <div class="progress" id="manhattanProgressSectionStandalone" style="display: none; text-align: center; margin-bottom: 15px;">
                                            <div id="manhattanProgressMessageStandalone">Processing data...</div>
                                            <div style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0; position: relative;">
                                                <div id="manhattanProgressFillStandalone" style="height: 100%; background: linear-gradient(90deg, #4CAF50, #45a049); transition: width 0.3s ease; width: 0%;"></div>
                                                <div id="manhattanProgressTextStandalone" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; color: #333; font-size: 12px;">0%</div>
                                            </div>
                                        </div>

                                        <div id="manhattanStatsStandalone" style="text-align: center; margin: 10px 0; color: #666; font-weight: 500;">
                                            Ready to plot Manhattan plot from cleaned GWAS data
                                        </div>

                                        <div id="manhattanPlotDivStandalone" style="width: 100%; height: 700px; border: 2px solid #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa; color: #666; font-size: 16px;">
                                            <div style="text-align: center;">
                                                <div style="font-size: 48px; margin-bottom: 10px;">üìä</div>
                                                <div>Manhattan plot will appear here</div>
                                                <div style="font-size: 14px; margin-top: 5px;">Click "Plot from Cleaned Data" to create visualization</div>
                                            </div>
                                        </div>

                                        <div class="mt-4">
                                            <h6>Features:</h6>
                                            <ul>
                                                <li><strong>Interactive Navigation:</strong> Click on any point to navigate to the genome browser</li>
                                                <li><strong>Significance Threshold:</strong> Toggle genome-wide significance line (p < 5√ó10‚Åª‚Å∏)</li>
                                                <li><strong>Export Options:</strong> Save plots as PNG or SVG for publications</li>
                                                <li><strong>Performance Optimized:</strong> Handles large datasets with WebGL rendering</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- JBrowse 3.6.5 Tab -->
                    <div class="tab-pane fade" id="jb365" role="tabpanel" aria-labelledby="jb365-tab">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">JBrowse 3.6.5 Genome Browser</h1>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Advanced Genome Browser</h5>
                                        <p class="card-text">Explore genomic data with the latest JBrowse 3.6.5 technology for interactive genome visualization.</p>

                                        <div class="alert alert-success">
                                            <strong>Navigation:</strong> You can navigate here directly from Manhattan plot points or use the controls below.
                                        </div>

                                        <div class="genome-controls" style="margin-bottom: 20px;">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <label for="locationInput" class="form-label">Navigate to Location:</label>
                                                    <input type="text" class="form-control" id="locationInput" placeholder="e.g., 1:1000-2000 or 2:5000000-5001000" value="1:1000-10000">
                                                </div>
                                                <div class="col-md-4 d-flex align-items-end">
                                                    <button class="btn btn-primary w-100" onclick="navigateToLocation()">
                                                        üß≠ Navigate
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="jbrowse_app_standalone" style="width: 100%; height: 700px; border: 2px solid #ddd; border-radius: 8px; background-color: #f8f9fa;">
                                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 16px; flex-direction: column;">
                                                <div style="font-size: 48px; margin-bottom: 10px;">üß¨</div>
                                                <div>JBrowse Genome Browser</div>
                                                <div style="font-size: 14px; margin-top: 5px;">Integrated genome browser for detailed genomic analysis</div>
                                            </div>
                                        </div>

                                        <div class="mt-4">
                                            <h6>Available Tracks:</h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <ul>
                                                        <li><strong>Reference Sequence:</strong> Camelina Sativa genome</li>
                                                        <li><strong>Structural Annotations:</strong> Gene models and features</li>
                                                        <li><strong>Variant Data:</strong> Untwist variant calls</li>
                                                        <li><strong>Expression Tracks:</strong> Tissue-specific expression</li>
                                                    </ul>
                                                </div>
                                                <div class="col-md-6">
                                                    <ul>
                                                        <li><strong>Stress Conditions:</strong> Salt/control comparisons</li>
                                                        <li><strong>Root Expression:</strong> DH55 root samples</li>
                                                        <li><strong>Shoot Expression:</strong> DH55 shoot samples</li>
                                                        <li><strong>Flower/Seed Data:</strong> Developmental stages</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="public/plotly.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    
    <!-- Application Scripts -->
    <script src="public/router.js"></script>
    <script src="public/gwas.js"></script>
    <script src="public/app.js"></script>
    <script src="js/genomeBrowser.js"></script>

    <!-- Helper functions -->
    <script>
        // File download helper function
        function downloadFileContent(filename, base64Content) {
            try {
                const content = atob(base64Content);
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                setTimeout(() => URL.revokeObjectURL(url), 1000);
            } catch (error) {
                console.error('Download error:', error);
                alert('Error downloading file: ' + error.message);
            }
        }

        // GWAS Analysis Functions (legacy support for workers)
        let gwasWorker = null;

        async function runGwasAnalysis() {
            const statusEl = document.getElementById('gwasStatus');
            const resultsEl = document.getElementById('gwasResults');
            const buttonEl = document.getElementById('runGwasButton');

            try {
                // Check if GWAS module is available
                if (!window.gwasModule || !window.gwasModule.isWorkerReady) {
                    throw new Error('PLINK2 worker not ready yet. Please wait for initialization.');
                }

                buttonEl.disabled = true;
                statusEl.textContent = 'Reading GWAS file from worker filesystem...';
                resultsEl.innerHTML = 'Initializing...';

                // Request file content from worker
                const filename = 'plink2.PHENO1.glm.linear';
                let fileContent;

                // Set up temporary message handler for file reading
                const originalHandler = window.gwasModule.plinkWorker.onmessage;
                
                window.gwasModule.plinkWorker.onmessage = function(e) {
                    const { type, data } = e.data;
                    
                    if (type === 'FILE_CONTENT' && data.filename === filename) {
                        if (data.isText) {
                            fileContent = data.content;
                            processGwasData();
                        } else {
                            throw new Error(`${filename} is not a text file`);
                        }
                        // Restore original handler
                        window.gwasModule.plinkWorker.onmessage = originalHandler;
                    } else if (type === 'FILE_READ_ERROR' && data.filename === filename) {
                        statusEl.textContent = 'Error: ' + data.error;
                        resultsEl.innerHTML = '<div style="color: red;">Error: ' + data.error + '</div>';
                        buttonEl.disabled = false;
                        // Restore original handler
                        window.gwasModule.plinkWorker.onmessage = originalHandler;
                    } else {
                        // Pass other messages to original handler
                        originalHandler(e);
                    }
                };

                // Request file from worker
                window.gwasModule.plinkWorker.postMessage({
                    type: 'READ_FILE',
                    data: { filename }
                });

                function processGwasData() {
                    try {
                        statusEl.textContent = 'Starting GWAS data processing...';
                        resultsEl.innerHTML = 'Processing...';

                // Create or restart worker
                if (gwasWorker) {
                    gwasWorker.terminate();
                }
                gwasWorker = new Worker('clean-data-worker.js');

                // Handle worker messages
                gwasWorker.onmessage = function(e) {
                    const { type, message, data, processed, total, valid } = e.data;

                    switch (type) {
                        case 'status':
                            statusEl.textContent = message;
                            break;

                        case 'progress':
                            statusEl.textContent = `Processing: ${processed.toLocaleString()}/${total.toLocaleString()} lines (${valid.toLocaleString()} valid)`;
                            const percentage = Math.round((processed / total) * 100);
                            resultsEl.innerHTML = `Progress: ${percentage}% - ${valid.toLocaleString()} valid entries found`;
                            break;

                        case 'complete':
                            statusEl.textContent = 'Analysis complete!';
                            // Store data globally for download functionality
                            window.lastGwasData = data;
                            displayGwasResults(data);
                            buttonEl.disabled = false;
                            break;

                        case 'error':
                            statusEl.textContent = 'Error: ' + message;
                            resultsEl.innerHTML = '<div style="color: red;">Error: ' + message + '</div>';
                            buttonEl.disabled = false;
                            break;
                    }
                };

                gwasWorker.onerror = function(error) {
                    statusEl.textContent = 'Worker error occurred';
                    resultsEl.innerHTML = '<div style="color: red;">Worker error: ' + error.message + '</div>';
                    buttonEl.disabled = false;
                };

                        // Start the worker with file content
                        gwasWorker.postMessage({
                            inputContent: fileContent,
                            outputType: 'full' // or 'test' for smaller dataset
                        });

                    } catch (error) {
                        statusEl.textContent = 'Error: ' + error.message;
                        resultsEl.innerHTML = '<div style="color: red;">Error: ' + error.message + '</div>';
                        buttonEl.disabled = false;
                    }
                }

            } catch (error) {
                statusEl.textContent = 'Error: ' + error.message;
                resultsEl.innerHTML = '<div style="color: red;">Error: ' + error.message + '</div>';
                buttonEl.disabled = false;
            }
        }

        function displayGwasResults(gwasData) {
            const resultsEl = document.getElementById('gwasResults');

            if (!gwasData || !gwasData.data || gwasData.data.length === 0) {
                resultsEl.innerHTML = '<div>No valid GWAS data found.</div>';
                return;
            }

            // Create summary
            let html = '<h4>GWAS Data Summary</h4>';
            html += `<p><strong>Total valid entries:</strong> ${gwasData.data.length.toLocaleString()}</p>`;
            if (gwasData.stats) {
                html += `<p><strong>Processed lines:</strong> ${gwasData.stats.totalLines.toLocaleString()}</p>`;
                html += `<p><strong>Valid lines:</strong> ${gwasData.stats.validLines.toLocaleString()}</p>`;
                html += `<p><strong>Filtered out:</strong> ${gwasData.stats.filteredLines.toLocaleString()}</p>`;
            }

            // Show data preview (first 10 rows)
            html += '<h4>Data Preview (first 10 rows)</h4>';
            html += '<table style="border-collapse: collapse; width: 100%;">';
            html += '<tr style="background-color: #f0f0f0;">';
            gwasData.header.forEach(col => {
                html += `<th style="border: 1px solid #ddd; padding: 8px;">${col}</th>`;
            });
            html += '</tr>';

            const previewData = gwasData.data.slice(0, 10);
            previewData.forEach(row => {
                html += '<tr>';
                row.forEach(cell => {
                    html += `<td style="border: 1px solid #ddd; padding: 8px;">${cell}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';

            // Add download functionality
            html += '<h4>Download</h4>';
            html += '<p>Click the button below to download the cleaned GWAS data:</p>';
            html += '<button class="btn btn-primary" onclick="downloadGwasData()" style="background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">üìÑ Download Cleaned GWAS Data (JSON)</button>';

            // Statistical summary
            if (gwasData.data.length > 0) {
                html += '<h4>Statistical Summary</h4>';

                let minP = Infinity;
                let maxP = -Infinity;
                let significantCount = 0;
                const chromosomeSet = new Set();

                const chunkSize = 10000;
                for (let i = 0; i < gwasData.data.length; i += chunkSize) {
                    const chunk = gwasData.data.slice(i, i + chunkSize);

                    for (const row of chunk) {
                        const pVal = row[2];
                        const chrom = row[0];

                        if (pVal < minP) minP = pVal;
                        if (pVal > maxP) maxP = pVal;
                        if (pVal < 5e-8) significantCount++;
                        chromosomeSet.add(chrom);
                    }
                }

                const chromosomes = Array.from(chromosomeSet).sort((a, b) => a - b);

                html += `<p><strong>P-value range:</strong> ${minP.toExponential(3)} - ${maxP.toFixed(4)}</p>`;
                html += `<p><strong>Chromosomes:</strong> ${chromosomes.join(', ')}</p>`;
                html += `<p><strong>Significant variants (p < 5e-8):</strong> ${significantCount.toLocaleString()}</p>`;
            }

            resultsEl.innerHTML = html;
        }

        function downloadGwasData() {
            try {
                if (!window.lastGwasData) {
                    alert('No GWAS data available for download');
                    return;
                }

                const jsonData = JSON.stringify(window.lastGwasData);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = 'gwas_cleaned_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                setTimeout(() => URL.revokeObjectURL(url), 1000);

            } catch (error) {
                console.error('Download error:', error);
                alert('Error creating download: ' + error.message);
            }
        }

        // Manhattan Plot Functions (additional legacy functions)
        let manhattanWorker = null;
        let manhattanCurrentData = null;
        let showSignificanceLine = true;
        let manhattanProcessingStartTime = 0;
        const significanceThreshold = -Math.log10(5e-8);

        const chrColors = [
            '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
            '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf',
            '#aec7e8', '#ffbb78', '#98df8a', '#ff9896', '#c5b0d5',
            '#c49c94', '#f7b6d3', '#c7c7c7', '#dbdb8d', '#9edae5',
            '#393b79', '#637939'
        ];

        function plotFromCleanedData() {
            // Implementation will be added when needed
            alert('Manhattan plot functionality will be implemented in a future update.');
        }

        function toggleSignificanceLinePlot() {
            showSignificanceLine = !showSignificanceLine;
            // Implementation will be added when needed
        }

        function exportPlotImage() {
            // Implementation will be added when needed
            alert('Export functionality will be implemented in a future update.');
        }

        function clearManhattanPlot() {
            const plotDiv = document.getElementById('manhattanPlotDiv');
            if (plotDiv) {
                plotDiv.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">Manhattan plot cleared. Click "Plot from Cleaned Data" to display data.</div>';
            }
            const statsDiv = document.getElementById('manhattanStats');
            if (statsDiv) {
                statsDiv.textContent = 'Manhattan plot cleared.';
            }
        }

        // Standalone Manhattan Plot Functions
        function plotFromCleanedDataStandalone() {
            console.log('Standalone Manhattan plot function called');
            if (!window.gwasModule) {
                alert('Please run GWAS analysis in the PLINK2 tool first to generate data for plotting.');
                return;
            }

            if (!window.gwasModule.manhattanCurrentData) {
                alert('No cleaned GWAS data available. Please run GWAS Data Clean in the PLINK2 tool first.');
                return;
            }

            // Use the enhanced GWAS module with standalone target
            window.gwasModule.plotFromCleanedData('manhattanPlotDivStandalone');
        }

        function toggleSignificanceLineStandalone() {
            if (window.gwasModule) {
                window.gwasModule.toggleSignificanceLinePlot();
            } else {
                alert('No GWAS data available. Please run GWAS analysis first.');
            }
        }

        function exportPlotImageStandalone() {
            if (window.gwasModule) {
                window.gwasModule.exportPlotImage();
            } else {
                alert('No plot available to export. Please create a plot first.');
            }
        }

        function exportPlotSVGStandalone() {
            if (window.gwasModule) {
                window.gwasModule.exportPlotSVG();
            } else {
                alert('No plot available to export. Please create a plot first.');
            }
        }

        function clearManhattanPlotStandalone() {
            const plotDiv = document.getElementById('manhattanPlotDivStandalone');
            const statsDiv = document.getElementById('manhattanStatsStandalone');

            if (plotDiv) {
                plotDiv.innerHTML = '<div style="text-align: center;"><div style="font-size: 48px; margin-bottom: 10px;">üìä</div><div>Manhattan plot cleared</div><div style="font-size: 14px; margin-top: 5px;">Click "Plot from Cleaned Data" to create visualization</div></div>';
            }

            if (statsDiv) {
                statsDiv.textContent = 'Ready to plot Manhattan plot from cleaned GWAS data';
            }
        }

        // JBrowse navigation function
        function navigateToLocation() {
            const locationInput = document.getElementById('locationInput');
            const location = locationInput.value.trim();

            if (!location) {
                alert('Please enter a location (e.g., 1:1000-2000)');
                return;
            }

            if (typeof jbNav === 'function') {
                jbNav(location);
            } else {
                alert('JBrowse navigation function not available');
            }
        }
    </script>
     
</body>
</html>